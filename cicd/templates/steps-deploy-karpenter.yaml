steps:
  # Install Helm
  - task: HelmInstaller@0
    displayName: 'Install Helm'
    inputs:
      helmVersion: '3.x'

  # Configure AWS Credentials
  - task: AWSShellScript@1
    displayName: 'KarpenterNodeRole'
    inputs:
      awsCredentials: '$(awsConnection)'
      regionName: '$(region)'
      scriptType: 'inline'
      inlineScript: |
        set -ex
        # Update kubeconfig
        aws eks --region $(region) update-kubeconfig --name $(clusterName)
        
        AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        KARPENTER_IAM_ROLE_NAME="KarpenterNodeRole-$(clusterName)"
        
        # Create IAM role and instance profile
        aws iam create-role \
          --role-name "${KARPENTER_IAM_ROLE_NAME}" \
          --assume-role-policy-document file://$(System.DefaultWorkingDirectory)/cicd/templates/karpenter-node-role-trust-policy.json
        
        aws iam attach-role-policy \
          --role-name "${KARPENTER_IAM_ROLE_NAME}" \
          --policy-arn arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy
        
        aws iam attach-role-policy \
          --role-name "${KARPENTER_IAM_ROLE_NAME}" \
          --policy-arn arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy
        
        aws iam attach-role-policy \
          --role-name "${KARPENTER_IAM_ROLE_NAME}" \
          --policy-arn arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
        
        aws iam attach-role-policy \
          --role-name "${KARPENTER_IAM_ROLE_NAME}" \
          --policy-arn arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore

  - task: AWSShellScript@1
    displayName: 'KarpenterControllerRole'
    inputs:
      awsCredentials: '$(awsConnection)'
      regionName: '$(region)'
      scriptType: 'inline'
      inlineScript: |
        set -ex
        # Update kubeconfig
        aws eks --region $(region) update-kubeconfig --name $(clusterName)

        AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        AWS_PARTITION=$(aws sts get-caller-identity --query Arn --output text | cut -d":" -f2)
        OIDC_ENDPOINT=$(aws eks describe-cluster --name $(clusterName) --query "cluster.identity.oidc.issuer" --output text)

        # Replace placeholders in the trust policy document
        sed -e "s/{{PARTITION}}/${AWS_PARTITION}/g" \
            -e "s/{{ACCOUNT_ID}}/${AWS_ACCOUNT_ID}/g" \
            -e "s|{{OIDC_ENDPOINT}}|${OIDC_ENDPOINT}|g" \
            $(System.DefaultWorkingDirectory)/cicd/templates/controller-trust-policy.json > /tmp/controller-trust-policy.json
        
        # Create IAM role for Karpenter Controller
        aws iam create-role --role-name "KarpenterControllerRole-$(clusterName)" \
          --assume-role-policy-document file:///tmp/controller-trust-policy.json

        
        # Replace placeholders in the policy document
        sed -e "s/{{PARTITION}}/${AWS_PARTITION}/g" \
            -e "s/{{ACCOUNT_ID}}/${AWS_ACCOUNT_ID}/g" \
            -e "s/{{CLUSTER_NAME}}/$(clusterName)/g" \
            $(System.DefaultWorkingDirectory)/cicd/templates/controller-policy.json > /tmp/controller-policy.json

        
        # Attach required policies to the role
        aws iam put-role-policy --role-name "KarpenterControllerRole-$(clusterName)" \
          --policy-name "KarpenterControllerPolicy" \
          --policy-document file:///tmp/controller-policy.json



  # Install Karpenter via Helm
  - task: AWSShellScript@1
    displayName: 'Deploy Karpenter'
    inputs:
      awsCredentials: '$(awsConnection)'
      regionName: '$(region)'
      scriptType: 'inline'
      inlineScript: |
        set -ex
        AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        AWS_DEFAULT_REGION=$(region)
        
        helm repo add karpenter https://charts.karpenter.sh/
        helm repo update
        
        helm upgrade --install karpenter oci://public.ecr.aws/karpenter/karpenter \
          --version v0.32.1 \
          --namespace karpenter \
          --create-namespace \
          --set "settings.aws.clusterName=$(clusterName)" \
          --set "settings.aws.defaultInstanceProfile=KarpenterNodeInstanceProfile-$(clusterName)" \
          --set "serviceAccount.annotations.eks\.amazonaws\.com/role-arn=arn:aws:iam::${AWS_ACCOUNT_ID}:role/KarpenterControllerRole-$(clusterName)"

  # Create Karpenter Provisioner
  - task: AWSShellScript@1
    displayName: 'Configure Karpenter Provisioner'
    inputs:
      awsCredentials: '$(awsConnection)'
      regionName: '$(region)'
      scriptType: 'inline'
      inlineScript: |
        set -ex
        cat <<EOF | kubectl apply -f -
        apiVersion: karpenter.sh/v1beta1
        kind: Provisioner
        metadata:
          name: default
        spec:
          requirements:
            - key: karpenter.k8s.aws/instance-category
              operator: In
              values: ["c", "m", "r"]
            - key: karpenter.k8s.aws/instance-generation
              operator: In
              values: ["5", "6"]
          limits:
            resources:
              cpu: 1000
          providerRef:
            name: default
        ---
        apiVersion: karpenter.k8s.aws/v1beta1
        kind: AWSNodeTemplate
        metadata:
          name: default
        spec:
          subnetSelector:
            karpenter.sh/discovery: "$(clusterName)"
          securityGroupSelector:
            karpenter.sh/discovery: "$(clusterName)"
        EOF